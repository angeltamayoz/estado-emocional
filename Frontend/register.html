<!DOCTYPE html>

<html lang="es">
<head><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>EmoTrack - Register</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="css/style.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet"/>
<!-- Inline SVG favicon to avoid 404 when no /favicon.ico is present -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' fill='%23007bff'/%3E%3Ctext x='8' y='11' font-size='9' text-anchor='middle' fill='white' font-family='Arial'%3EE%3C/text%3E%3C/svg%3E">
</head>

<body class="bg-hero">
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="dashboard.html">EmoTrack</a>
      <div class="ms-auto navbar-nav">
        <a class="nav-link" href="dashboard.html">Dashboard</a>
        <a class="nav-link active" href="register.html">Registro</a>
        <a class="nav-link" href="login.html">Login</a>
      </div>
    </div>
  </nav>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card shadow-sm fade-up">
          <div class="card-body">
            <h3 class="card-title mb-4">Crear cuenta</h3>
            <form id="registerForm" autocomplete="off" novalidate>
              <div class="mb-3">
                <label for="reg_username">Usuario</label>
                <input class="form-control" id="reg_username" required minlength="3" maxlength="20" pattern="^[a-zA-Z0-9_]+$" />
                <div class="invalid-feedback">El usuario debe tener entre 3 y 20 caracteres y solo letras, números o guion bajo.</div>
              </div>
              <div class="mb-3">
                <label for="reg_email">Email</label>
                <input class="form-control" id="reg_email" required type="email" />
                <div class="invalid-feedback">Introduce un email válido.</div>
              </div>
              <div class="mb-3">
                <label for="reg_password">Contraseña</label>
                <input class="form-control" id="reg_password" required type="password" minlength="6" />
                <div class="invalid-feedback">La contraseña debe tener al menos 6 caracteres.</div>
              </div>
              <button class="btn btn-primary w-100" type="submit">Registrarse</button>
            </form>
            <div class="mt-3 text-center small-muted"><a href="login.html">¿Ya tienes cuenta? Inicia sesión</a></div>
          </div>
        </div>
      </div>
    </div>
  </div>


<script src="js/config.js"></script>
<script src="js/auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Validación en tiempo real para registro
const regForm = document.getElementById('registerForm');
const regFields = {
  username: document.getElementById('reg_username'),
  email: document.getElementById('reg_email'),
  password: document.getElementById('reg_password')
};

function validateUsername(val) {
  return /^[a-zA-Z0-9_]{3,20}$/.test(val);
}
function validateEmail(val) {
  return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(val);
}
function validatePassword(val) {
  return val.length >= 6;
}

function setFieldState(field, valid) {
  if (valid) {
    field.classList.remove('is-invalid');
    field.classList.add('is-valid');
  } else {
    field.classList.remove('is-valid');
    field.classList.add('is-invalid');
  }
}

regFields.username.addEventListener('input', e => {
  setFieldState(e.target, validateUsername(e.target.value));
});
regFields.email.addEventListener('input', e => {
  setFieldState(e.target, validateEmail(e.target.value));
});
regFields.password.addEventListener('input', e => {
  setFieldState(e.target, validatePassword(e.target.value));
});

regForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const username = regFields.username.value.trim();
  const email = regFields.email.value.trim();
  const password = regFields.password.value.trim();

  let valid = true;
  setFieldState(regFields.username, validateUsername(username));
  setFieldState(regFields.email, validateEmail(email));
  setFieldState(regFields.password, validatePassword(password));
  if (!validateUsername(username) || !validateEmail(email) || !validatePassword(password)) {
    valid = false;
  }
  if (!valid) {
    Swal.fire({ icon:'error', title:'Datos inválidos', text:'Por favor corrige los campos marcados.' });
    return;
  }

  try {
    const res = await fetch(window.API_BASE + '/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, email, password })
    });
    if (!res.ok) {
      const txt = await res.text().catch(()=>null);
      throw new Error(txt || 'Registro fallido');
    }
    const data = await res.json();

    const token = data.access_token || data.token || null;
    const usernameResp = (data.user && data.user.username) || data.username || username;

    if (!token) throw new Error('Respuesta no incluye token');

    localStorage.setItem('token', token);
    localStorage.setItem('username', usernameResp);

    Swal.fire({
      title: '¡Cuenta creada!',
      text: 'Usuario registrado con éxito.',
      icon: 'success',
      confirmButtonText: 'Ir al dashboard',
      showClass: { popup: 'fade-up' }
    }).then(() => {
      window.location.href = 'dashboard.html';
    });

  } catch (err) {
    console.error('Register error', err);
    Swal.fire({ title:'Error', text: err.message || 'Registro fallido', icon:'error' });
  }
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function(){ if(window.AOS) AOS.init({duration:600,once:true}); });
</script>

<div id="toastContainer"></div>



</body>
</html>